<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proyecto Vue con Vuex</title>
  <!-- Vuetify CDN -->
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.5.10/dist/vuetify.min.css" rel="stylesheet">
  <!-- Vue CDN -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
  <!-- Vuex CDN -->
  <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
  <!-- Axios CDN -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<div id="app">
  <v-app>
    <v-container>
      <v-toolbar flat>
        <v-toolbar-title>Auditoría de pacientes</v-toolbar-title>
        <v-spacer></v-spacer>
        <v-btn color="primary" @click="abrirModalCrearAuditoria" dark>Crear Auditoría de paciente</v-btn>
      </v-toolbar>

      <!-- Tabla de Auditoría de pacientes -->
      <v-data-table
        :headers="headers"
        :items="auditoriaPacientes"
        item-value="name"
        class="elevation-1"
      >
        <template v-slot:item.actions="{ item }">
          <!-- Botón para agregar observación -->
          <v-btn text icon color="green" @click="abrirModalCrearObservacion(item)">
            <v-icon>post_add</v-icon>
          </v-btn>
          <!-- Botón para ver observaciones -->
          <v-btn text icon color="blue" @click="abrirModalVerObservaciones(item)">
            <v-icon>note_add</v-icon>
          </v-btn>
          <!-- Botón para cerrar auditoría, deshabilitado si el estado es 2 -->
          <v-btn text icon color="red" @click="abrirModalCerrarAuditoria(item)" :disabled="item.estado === 2">
            <v-icon>check</v-icon>
          </v-btn>
        </template>
      </v-data-table>

      <!-- Modales para Crear Auditoría, Ver Observaciones, Crear Observación y Cerrar Auditoría -->
      <!-- Aquí se incluyen los modales según el diseño que compartiste antes -->

    </v-container>
  </v-app>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.5.10/dist/vuetify.js"></script>
<script>
  // Configuración de Vuex Store
  const store = new Vuex.Store({
    state: {
      auditoriaPacientes: [], // Almacenará los datos obtenidos desde el endpoint
      nuevoPaciente: {
        numeroDocumento: '',
        tipoDocumento: ''
      }
    },
    mutations: {
      SET_AUDITORIA_PACIENTES(state, pacientes) {
        state.auditoriaPacientes = pacientes;
      },
      CREAR_AUDITORIA(state, paciente) {
        state.auditoriaPacientes.push(paciente);
      }
    },
    actions: {
      async fetchAuditoriaPacientes({ commit }) {
        try {
          const response = await axios.post('/getDocumentosData');
          const pacientes = response.data.documentos.map(doc => ({
            numeroDocumento: doc.cufeCude,
            tipoDocumento: doc.tipoDocumento,
            nombresApellidos: `${doc.nombreEmisor} ${doc.nombreReceptor}`,
            sexo: '', // Ajusta este y otros campos según sea necesario
            edad: '', // Si hay datos adicionales para calcular la edad, los puedes incluir aquí
            municipioResidencia: '',
            cohorte: doc.grupo,
            ipsAsignada: doc.nombreReceptor
          }));
          commit('SET_AUDITORIA_PACIENTES', pacientes);
        } catch (error) {
          console.error('Error al obtener datos:', error);
        }
      },
      crearAuditoria({ commit, state }) {
        commit('CREAR_AUDITORIA', { ...state.nuevoPaciente });
        state.nuevoPaciente.numeroDocumento = '';
        state.nuevoPaciente.tipoDocumento = '';
      }
    },
    getters: {
      auditoriaPacientes: (state) => state.auditoriaPacientes,
      nuevoPaciente: (state) => state.nuevoPaciente
    }
  });

  // Inicialización de Vue con Vuex y Vuetify
  new Vue({
    el: '#app',
    vuetify: new Vuetify(),
    store, // Vuex Store
    computed: {
      auditoriaPacientes() {
        return this.$store.getters.auditoriaPacientes;
      },
      nuevoPaciente() {
        return this.$store.state.nuevoPaciente;
      }
    },
    data() {
      return {
        dialogCrearAuditoria: false,
        dialogVerObservaciones: false,
        dialogCerrarAuditoria: false,
        dialogCrearObservacion: false,
        pacienteSeleccionado: null,
        nuevaObservacion: '',
        headers: [
          { text: 'Número Documento', value: 'numeroDocumento' },
          { text: 'Tipo Documento', value: 'tipoDocumento' },
          { text: 'Nombres y Apellidos', value: 'nombresApellidos' },
          { text: 'Sexo', value: 'sexo' },
          { text: 'Edad', value: 'edad' },
          { text: 'Municipio Residencia', value: 'municipioResidencia' },
          { text: 'Cohorte', value: 'cohorte' },
          { text: 'IPS Asignada', value: 'ipsAsignada' },
          { text: 'Acciones', value: 'actions', sortable: false },
        ]
      };
    },
    methods: {
      abrirModalCrearAuditoria() {
        this.dialogCrearAuditoria = true;
      },
      submitForm() {
        this.$store.dispatch('crearAuditoria');
        this.dialogCrearAuditoria = false;
      },
      abrirModalCrearObservacion(item) {
        this.pacienteSeleccionado = item;
        this.dialogCrearObservacion = true;
      },
      agregarObservacion() {
        console.log('Agregando observación:', this.nuevaObservacion, 'para el paciente', this.pacienteSeleccionado);
        this.nuevaObservacion = '';
        this.dialogCrearObservacion = false;
      },
      abrirModalVerObservaciones(item) {
        this.pacienteSeleccionado = item;
        this.dialogVerObservaciones = true;
      },
      abrirModalCerrarAuditoria(item) {
        this.pacienteSeleccionado = item;
        this.dialogCerrarAuditoria = true;
      },
      cerrarAuditoria() {
        console.log('Cerrando auditoría para:', this.pacienteSeleccionado);
        this.dialogCerrarAuditoria = false;
      }
    },
    created() {
      // Cargar los datos desde el endpoint al iniciar la app
      this.$store.dispatch('fetchAuditoriaPacientes');
    }
  });
</script>

</body>
</html>
